
-- ==============================================================================
-- SETUP COMPLETO: CRIAÇÃO DE TABELAS & CORREÇÃO DE RECURSÃO (SECURITY DEFINER)
-- Execute este script no SQL Editor do Supabase.
-- Ele recria toda a estrutura necessária para o Painel Admin e Cliente.
-- ==============================================================================

-- 1. EXTENSÕES
create extension if not exists "uuid-ossp";

-- ==============================================================================
-- 2. TABELAS (RECRIAR ESTRUTURA)
-- ==============================================================================

-- 2.1 PERFIS
create table if not exists public.profiles (
  id uuid references auth.users on delete cascade not null primary key,
  email text not null,
  full_name text,
  role text check (role in ('admin', 'client')) default 'client',
  avatar_url text,
  phone text,
  company_name text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2.2 PROJETOS (A tabela que estava faltando)
create table if not exists public.projects (
  id uuid default uuid_generate_v4() primary key,
  user_id uuid references public.profiles(id) on delete cascade not null,
  name text not null,
  description text,
  status text check (status in ('new', 'briefing', 'development', 'review', 'completed', 'cancelled')) default 'new',
  progress integer default 0 check (progress between 0 and 100),
  due_date date,
  next_milestone text,
  preview_url text,
  repo_url text,
  figma_url text,
  financial_data jsonb default '{"total": 0, "paid": 0, "status": "pending"}'::jsonb,
  contract_data jsonb default '{"status": "draft"}'::jsonb,
  temp_password text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2.3 ARQUIVOS
create table if not exists public.project_files (
  id uuid default uuid_generate_v4() primary key,
  project_id uuid references public.projects(id) on delete cascade not null,
  uploaded_by uuid references public.profiles(id),
  name text not null,
  size text,
  type text,
  url text not null,
  category text default 'general',
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2.4 NOTIFICAÇÕES
create table if not exists public.notifications (
  id uuid default uuid_generate_v4() primary key,
  user_id uuid references public.profiles(id) on delete cascade not null,
  project_id uuid references public.projects(id) on delete cascade,
  title text not null,
  message text not null,
  type text check (type in ('info', 'success', 'warning', 'payment', 'alert')) default 'info',
  is_read boolean default false,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2.5 ATIVIDADES
create table if not exists public.project_activities (
  id uuid default uuid_generate_v4() primary key,
  project_id uuid references public.projects(id) on delete cascade not null,
  text text not null,
  type text check (type in ('info', 'success', 'alert')) default 'info',
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2.6 LEADS (CRM)
create table if not exists public.leads (
  id uuid default uuid_generate_v4() primary key,
  name text not null,
  email text not null,
  project_type text,
  budget text,
  message text,
  status text default 'new',
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2.7 BLOG
create table if not exists public.blog_posts (
  id uuid default uuid_generate_v4() primary key,
  slug text unique,
  title text not null,
  excerpt text,
  content text,
  image_url text,
  category text,
  author text default 'Philippe Boechat',
  read_time text default '5 min',
  is_published boolean default true,
  published_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- ==============================================================================
-- 3. SEGURANÇA E CORREÇÃO DE RECURSÃO (CRÍTICO)
-- ==============================================================================

-- Habilitar RLS
alter table public.profiles enable row level security;
alter table public.projects enable row level security;
alter table public.project_files enable row level security;
alter table public.notifications enable row level security;
alter table public.project_activities enable row level security;
alter table public.leads enable row level security;
alter table public.blog_posts enable row level security;

-- *** AQUI ESTÁ A CORREÇÃO DA RECURSÃO ***
-- Usamos 'SECURITY DEFINER' para que a função rode com privilégios de sistema,
-- ignorando o RLS da tabela profiles ao verificar se é admin.
CREATE OR REPLACE FUNCTION public.is_admin()
RETURNS BOOLEAN 
LANGUAGE plpgsql 
SECURITY DEFINER 
SET search_path = public
AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM public.profiles
    WHERE id = auth.uid() AND role = 'admin'
  );
END;
$$;

-- 3.1 POLÍTICAS PROFILES
DROP POLICY IF EXISTS "Painel: Admins veem todos" ON public.profiles;
DROP POLICY IF EXISTS "Painel: Admins editam todos" ON public.profiles;
DROP POLICY IF EXISTS "Cliente: Vê apenas o seu" ON public.profiles;
DROP POLICY IF EXISTS "Cliente: Edita apenas o seu" ON public.profiles;

CREATE POLICY "Painel: Admins veem todos" ON public.profiles FOR SELECT USING ( is_admin() );
CREATE POLICY "Painel: Admins editam todos" ON public.profiles FOR UPDATE USING ( is_admin() );
CREATE POLICY "Cliente: Vê apenas o seu" ON public.profiles FOR SELECT USING ( auth.uid() = id );
CREATE POLICY "Cliente: Edita apenas o seu" ON public.profiles FOR UPDATE USING ( auth.uid() = id );

-- 3.2 POLÍTICAS PROJETOS
DROP POLICY IF EXISTS "Admin: Gerencia tudo" ON public.projects;
DROP POLICY IF EXISTS "Cliente: Vê seus projetos" ON public.projects;

CREATE POLICY "Admin: Gerencia tudo" ON public.projects FOR ALL USING ( is_admin() );
CREATE POLICY "Cliente: Vê seus projetos" ON public.projects FOR SELECT USING ( auth.uid() = user_id );

-- 3.3 POLÍTICAS ARQUIVOS
DROP POLICY IF EXISTS "Admin: Gerencia arquivos" ON public.project_files;
DROP POLICY IF EXISTS "Cliente: Vê arquivos do projeto" ON public.project_files;
DROP POLICY IF EXISTS "Cliente: Upload nos seus projetos" ON public.project_files;

CREATE POLICY "Admin: Gerencia arquivos" ON public.project_files FOR ALL USING ( is_admin() );

CREATE POLICY "Cliente: Vê arquivos do projeto" ON public.project_files 
FOR SELECT USING (
  EXISTS (
    SELECT 1 FROM public.projects 
    WHERE id = project_files.project_id 
    AND user_id = auth.uid()
  )
);

CREATE POLICY "Cliente: Upload nos seus projetos" ON public.project_files 
FOR INSERT WITH CHECK (
  EXISTS (
    SELECT 1 FROM public.projects 
    WHERE id = project_files.project_id 
    AND user_id = auth.uid()
  )
);

-- 3.4 POLÍTICAS ATIVIDADES
DROP POLICY IF EXISTS "Admin: Cria logs" ON public.project_activities;
DROP POLICY IF EXISTS "Todos: Veem logs do projeto" ON public.project_activities;

CREATE POLICY "Admin: Cria logs" ON public.project_activities FOR INSERT WITH CHECK ( is_admin() );

CREATE POLICY "Todos: Veem logs do projeto" ON public.project_activities 
FOR SELECT USING (
  EXISTS (
    SELECT 1 FROM public.projects 
    WHERE id = project_activities.project_id 
    AND (user_id = auth.uid() OR is_admin())
  )
);

-- 3.5 POLÍTICAS NOTIFICAÇÕES
DROP POLICY IF EXISTS "Admin: Envia notificações" ON public.notifications;
DROP POLICY IF EXISTS "Cliente: Vê suas notificações" ON public.notifications;
DROP POLICY IF EXISTS "Cliente: Atualiza suas notificações" ON public.notifications;

CREATE POLICY "Admin: Envia notificações" ON public.notifications FOR INSERT WITH CHECK ( is_admin() );
CREATE POLICY "Cliente: Vê suas notificações" ON public.notifications FOR SELECT USING ( auth.uid() = user_id );
CREATE POLICY "Cliente: Atualiza suas notificações" ON public.notifications FOR UPDATE USING ( auth.uid() = user_id );

-- 3.6 POLÍTICAS LEADS
DROP POLICY IF EXISTS "Admin: Gerencia leads" ON public.leads;
DROP POLICY IF EXISTS "Público: Cria leads" ON public.leads;

CREATE POLICY "Admin: Gerencia leads" ON public.leads FOR ALL USING ( is_admin() );
CREATE POLICY "Público: Cria leads" ON public.leads FOR INSERT WITH CHECK ( true );

-- 3.7 POLÍTICAS BLOG
DROP POLICY IF EXISTS "Leitura pública do blog" ON public.blog_posts;
DROP POLICY IF EXISTS "Admin gerencia blog" ON public.blog_posts;

create policy "Leitura pública do blog" on public.blog_posts for select using ( true );
create policy "Admin gerencia blog" on public.blog_posts for all using ( is_admin() );

-- ==============================================================================
-- 4. TRIGGERS AUTOMÁTICOS
-- ==============================================================================

-- Cria perfil ao cadastrar usuário
create or replace function public.handle_new_user() 
returns trigger 
language plpgsql 
security definer 
set search_path = public
as $$
begin
  insert into public.profiles (id, email, full_name, role)
  values (
    new.id, 
    new.email, 
    new.raw_user_meta_data->>'full_name',
    coalesce(new.raw_user_meta_data->>'role', 'client')
  )
  ON CONFLICT (id) DO NOTHING;
  return new;
end;
$$;

drop trigger if exists on_auth_user_created on auth.users;
create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();

-- Atualiza timestamp
create or replace function update_updated_at_column()
returns trigger as $$
begin
    new.updated_at = now();
    return new;
end;
$$ language plpgsql;

drop trigger if exists update_projects_modtime on public.projects;
create trigger update_projects_modtime before update on public.projects for each row execute procedure update_updated_at_column();
